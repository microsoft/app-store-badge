trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
    submodules: true

  # Set permissions
  - script: |
      ls -l .npmrc
      ls -l
      sudo chmod -R 644 .
    displayName: 'Fix Repository Permissions'

    
  # Authenticate to NPM
  - task: NpmAuthenticate@0
    inputs:
      workingFile: '.npmrc'

  # Build steps for the project
  - script: |
      cd src
      tsc -t es2015 ms-store-badge.ts
      npm install
      npm run build:prod
      cd ..
    displayName: 'Build Project'

  # Deploy to Azure Static Web App
  - task: AzureStaticWebApp@0
    inputs:
      app_location: '/' 
      api_location: '' 
      output_location: '/dist'  # Built app content directory relative to app_location
      azure_static_web_apps_api_token: $(DEPLOYMENT_TOKEN)

  # Publish build artifacts
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)/dist'
      ArtifactName: 'ms-store-badge-artifacts'
      publishLocation: 'Container'
